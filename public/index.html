<!doctype html><meta charset="utf-8" /><meta
  name="viewport"
  content="width=device-width,initial-scale=1"
/>
<title>超簡易・日付投票</title>
<style>
  :root {
    --blue-primary: #0052cc;
    --blue-hover: #0065ff;
    --green-success: #00875a;
    --red-danger: #de350b;
    --warning-text: #8f5b00;
    --warning-border: #ffe2b0;
    --warning-bg: #fff7e6;
    --text-strong: #091e42;
    --text-muted: #6b778c;
    --border: #dfe1e6;
    --background: #f4f5f7;
  }

  * {
    box-sizing: border-box;
  }

  body {
    font-family:
      -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu,
      'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
    font-size: 14px;
    color: var(--text-strong);
    background: var(--background);
    margin: 32px auto;
    max-width: 960px;
    padding: 0 24px;
    line-height: 1.5;
  }

  h1,
  h2,
  h3 {
    color: var(--text-strong);
    font-weight: 700;
    margin: 0 0 16px;
    line-height: 1.2;
  }

  h1 {
    font-size: 24px;
  }

  h2 {
    font-size: 20px;
  }

  h3 {
    font-size: 16px;
  }

  .card {
    background: #fff;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 24px;
    margin: 16px 0;
    box-shadow: 0 6px 12px -6px rgba(9, 30, 66, 0.25);
  }

  .row,
  .url-row {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }

  .form-group {
    margin-bottom: 16px;
  }

  .form-group label {
    display: block;
    margin-bottom: 4px;
    font-weight: 600;
    color: #172b4d;
  }

  .grid {
    display: grid;
    grid-template-columns: repeat(7, minmax(100px, 1fr));
    gap: 12px;
  }

  .calendar {
    display: grid;
    gap: 12px;
  }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, minmax(100px, 1fr));
    gap: 12px;
  }

  .calendar-header {
    text-align: center;
    color: var(--text-muted);
    font-weight: 700;
    font-size: 13px;
  }

  .day-label {
    padding: 6px 4px;
    border-bottom: 1px solid var(--border);
  }

  .day-label.sunday {
    color: #c0392b;
  }

  .day-label.saturday {
    color: #1f4b99;
  }

  .date-cell {
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 14px;
    background: #fff;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    cursor: pointer;
    min-height: 60px;
    transition:
      transform 140ms ease,
      border-color 140ms ease,
      box-shadow 140ms ease,
      background 140ms ease,
      color 140ms ease;
  }

  .date-cell:hover {
    transform: translateY(-1px);
    background: #f8faff;
    border-color: #c8def4;
    box-shadow: 0 4px 10px -6px rgba(9, 30, 66, 0.3);
  }

  .date-cell:focus-visible {
    outline: none;
    border-color: var(--blue-primary);
    box-shadow: 0 0 0 2px rgba(0, 82, 204, 0.25);
  }

  .date-cell.active {
    background: var(--blue-primary);
    border-color: var(--blue-primary);
    color: #fff;
    box-shadow: 0 6px 16px -8px rgba(0, 82, 204, 0.6);
  }

  .date-cell.active:hover {
    background: #0747a6;
    border-color: #0747a6;
  }

  .date-cell.disabled {
    cursor: not-allowed;
    opacity: 0.65;
  }

  .date-cell.sunday:not(.active) {
    background: #fff7f7;
    border-color: #ffdede;
  }

  .date-cell.saturday:not(.active) {
    background: #f7f9ff;
    border-color: #dce6ff;
  }

  .date-label {
    font-weight: 700;
  }

  .date-cell.active .date-label {
    color: #fff;
  }

  input,
  textarea,
  select {
    font: inherit;
    color: var(--text-strong);
    background: #fff;
    border: 2px solid var(--border);
    border-radius: 3px;
    padding: 8px;
    transition:
      border-color 120ms ease,
      box-shadow 120ms ease;
  }

  input:focus,
  textarea:focus,
  select:focus {
    outline: none;
    border-color: var(--blue-primary);
    box-shadow: 0 0 0 2px rgba(0, 82, 204, 0.25);
  }

  .url-input {
    font-family: monospace;
    width: fit-content;
    max-width: 100%;
    padding: 10px 12px;
    background: #f7f8f9;
    border: 1px solid #c1c7d0;
    box-shadow: inset 0 1px 1px rgba(9, 30, 66, 0.08);
  }

  button {
    font: inherit;
    height: 32px;
    padding: 0 12px;
    border-radius: 3px;
    border: 1px solid var(--border);
    background: #fafbfc;
    color: #42526e;
    cursor: pointer;
    transition:
      background 120ms ease,
      border-color 120ms ease,
      box-shadow 120ms ease,
      color 120ms ease;
  }

  button:hover {
    background: #ebecf0;
    border-color: #c1c7d0;
  }

  button:focus-visible {
    outline: none;
    border-color: var(--blue-primary);
    box-shadow: 0 0 0 2px rgba(0, 82, 204, 0.25);
  }

  button.primary {
    background: var(--blue-primary);
    border-color: var(--blue-primary);
    color: #fff;
  }

  button.primary:hover {
    background: var(--blue-hover);
    border-color: var(--blue-hover);
  }

  .pill {
    border: 1px solid #dfe1e6;
    padding: 10px 14px;
    border-radius: 10px;
    display: inline-flex;
    gap: 10px;
    align-items: center;
    background: #fff;
    box-shadow: 0 1px 2px rgba(9, 30, 66, 0.15);
    transition:
      background 140ms ease,
      border-color 140ms ease,
      box-shadow 140ms ease,
      color 140ms ease;
    height: auto;
    min-height: 44px;
  }

  .pill:hover {
    background: #f4f5f7;
    border-color: #c1c7d0;
    cursor: pointer;
  }

  .pill.active {
    background: var(--blue-primary);
    border-color: var(--blue-primary);
    color: #fff;
    box-shadow: 0 4px 12px -6px rgba(0, 82, 204, 0.6);
  }

  .pill.active:hover {
    background: #0747a6;
    border-color: #0747a6;
  }

  .pill-badge {
    background: #e9f2ff;
    color: #0747a6;
    border-radius: 999px;
    padding: 4px 8px;
    font-weight: 700;
    border: 1px solid #c8def4;
    line-height: 1;
  }

  .pill.active .pill-badge {
    background: rgba(255, 255, 255, 0.16);
    color: #fff;
    border-color: rgba(255, 255, 255, 0.24);
  }

  .date-cell.active .pill-badge {
    background: rgba(255, 255, 255, 0.16);
    color: #fff;
    border-color: rgba(255, 255, 255, 0.24);
  }

  .muted {
    color: var(--text-muted);
  }

  .error-message {
    color: var(--red-danger);
    margin: 8px 0;
    padding: 10px 12px;
    background: #ffebe6;
    border-radius: 3px;
    border: 1px solid #ffbdad;
    font-size: 14px;
  }

  .input-error {
    border-color: var(--red-danger);
    box-shadow: 0 0 0 2px rgba(222, 53, 11, 0.2);
    background: #ffebe6;
  }

  textarea {
    width: 100%;
    resize: vertical;
  }

  .card + .card {
    margin-top: 24px;
  }

  .url-row {
    gap: 12px;
    align-items: flex-start;
    padding: 12px;
    background: #f7f8f9;
    border-radius: 4px;
    border: 1px solid var(--border);
  }

  .status-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
    margin-bottom: 12px;
    min-height: 32px;
  }

  .status-row > *:first-child {
    flex: 1 1 auto;
  }

  .vote-status {
    font-weight: 600;
  }

  .vote-counter {
    white-space: nowrap;
    color: var(--text-muted);
    font-weight: 600;
    flex-shrink: 0;
  }
</style>
<div id="app"></div>
<script>
  const API = '/api';
  function el(t, a = {}, ...c) {
    const e = document.createElement(t);
    for (const [k, v] of Object.entries(a)) {
      if (k === 'class') e.className = v;
      else if (k.startsWith('on')) e.addEventListener(k.slice(2), v);
      // Booleans need property assignment; setAttribute('disabled', false) still disables the element.
      else if (typeof v === 'boolean')
        k in e ? (e[k] = v) : v && e.setAttribute(k, '');
      else e.setAttribute(k, v);
    }
    for (const x of c) e.append(x.nodeType ? x : document.createTextNode(x));
    return e;
  }
  function hash() {
    return location.hash.split('?')[0] || '#/create';
  }
  function qs() {
    return Object.fromEntries(
      new URLSearchParams(location.hash.split('?')[1] || '')
    );
  }
  function set(n, d) {
    n.innerHTML = '';
    n.append(d);
  }
  function fmtJP(iso) {
    const [Y, M, D] = iso.split('-').map(Number);
    const dt = new Date(Y, M - 1, D);
    const w = ['日', '月', '火', '水', '木', '金', '土'][dt.getDay()];
    return `${M}/${D} (${w})`;
  }
  const formStore = {
    get(formId) {
      try {
        return JSON.parse(localStorage.getItem('form:' + formId));
      } catch {
        return null;
      }
    },
    save(formId, secret) {
      if (!formId || !secret) return;
      const payload = {
        formId,
        secret,
        createdAt: Date.now(),
      };
      try {
        localStorage.setItem('form:' + formId, JSON.stringify(payload));
      } catch {
        /* ignore */
      }
    },
  };
  const store = {
    get(f) {
      try {
        return JSON.parse(localStorage.getItem('voted:' + f) || '[]');
      } catch {
        return [];
      }
    },
    add(f, d) {
      const a = this.get(f);
      if (!a.includes(d)) {
        a.push(d);
        localStorage.setItem('voted:' + f, JSON.stringify(a));
      }
    },
    remove(f, d) {
      const a = this.get(f).filter(x => x !== d);
      localStorage.setItem('voted:' + f, JSON.stringify(a));
    },
  };

  function Create() {
    const app = el('div');
    const today = new Date().toISOString().split('T')[0];
    const startId = 'start-date',
      endId = 'end-date',
      msgId = 'message',
      daysId = 'max-days';
    const s = el('input', { id: startId, type: 'date', value: today }),
      e = el('input', { id: endId, type: 'date' }),
      msg = el('textarea', {
        id: msgId,
        placeholder: 'メッセージ（省略可）',
        rows: 3,
      });
    const days = el('input', {
      id: daysId,
      type: 'number',
      value: '',
      style: 'width:80px',
    });
    const errorMsg = el('div', {
      class: 'error-message',
      style: 'display: none;',
    });
    const clearError = () => {
      errorMsg.textContent = '';
      errorMsg.style.display = 'none';
      [s, e, msg, days].forEach(input => input.classList.remove('input-error'));
    };
    [s, e].forEach(input => input.addEventListener('input', clearError));
    const btn = el(
      'button',
      {
        class: 'primary',
        onclick: async () => {
          if (!s.value || !e.value) {
            errorMsg.textContent = '開始日と終了日は必須です';
            errorMsg.style.display = 'block';
            if (!s.value) s.classList.add('input-error');
            if (!e.value) e.classList.add('input-error');
            return;
          }
          clearError();
          const r = await fetch(API + '/forms', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({
              startDate: s.value,
              endDate: e.value,
              message: msg.value || '',
              days: days.value === '' ? null : days.value,
            }),
          });
          const j = await r.json();
          if (!r.ok) {
            alert('作成失敗:' + (j.error || r.status));
            return;
          }
          // editUrl already includes formId/secret in the hash fragment; no need to parse as a full URL
          const h = j.editUrl?.split('#')[1];
          const secret =
            h && h.includes('?')
              ? new URLSearchParams(h.split('?')[1]).get('secret')
              : null;
          formStore.save(j.formId, secret);
          location.hash = h ? '#' + h : `#/edit?formId=${j.formId}`;
        },
      },
      '作成'
    );
    set(
      app,
      el(
        'div',
        {},
        el('h2', {}, 'フォーム作成'),
        el(
          'div',
          { class: 'card' },
          el(
            'div',
            { class: 'form-group' },
            el('label', { for: startId }, '開始日'),
            s
          ),
          el(
            'div',
            { class: 'form-group' },
            el('label', { for: endId }, '終了日'),
            e
          ),
          el(
            'div',
            { class: 'form-group' },
            el('label', { for: msgId }, 'メッセージ'),
            msg
          ),
          el(
            'div',
            { class: 'form-group' },
            el('label', { for: daysId }, '投票できる最大の日数（省略可）'),
            days
          ),
          errorMsg,
          el('div', { class: 'row' }, btn)
        )
      )
    );
    return app;
  }

  function Edit(q) {
    const app = el('div');
    const { formId, secret: urlSecret } = q;
    if (!formId) {
      return (set(app, el('div', {}, 'formIdがありません')), app);
    }

    let secret = urlSecret;
    if (!secret) {
      const saved = formStore.get(formId);
      if (saved?.secret) {
        location.hash = `#/edit?formId=${formId}&secret=${saved.secret}`;
        return app;
      }
      return (
        set(
          app,
          el('div', {}, 'secretがありません。作成時のURLを使用してください。')
        ),
        app
      );
    }
    const editUrl = `${location.origin}${location.pathname}#/edit?formId=${formId}&secret=${secret}`;
    const editUrlId = `edit-url-${formId}`;
    const urlInput = el('input', {
      type: 'text',
      value: editUrl,
      readonly: true,
      class: 'url-input',
      id: editUrlId,
    });
    urlInput.size = Math.min(Math.max(editUrl.length + 2, 40), 140);
    const copyBtn = el(
      'button',
      {
        onclick: async () => {
          try {
            await navigator.clipboard.writeText(editUrl);
          } catch (e) {
            urlInput.select();
            document.execCommand('copy');
          }
          copyBtn.textContent = 'コピー済み';
          setTimeout(() => (copyBtn.textContent = 'コピー'), 1200);
        },
      },
      'コピー'
    );
    set(
      app,
      el(
        'div',
        {},
        el('h2', {}, '編集'),
        el(
          'div',
          { class: 'card' },
          el('div', {}, 'フォームID: ', formId),
          el('a', { href: '#/vote?formId=' + formId }, '投票画面へ'),
          el(
            'div',
            { class: 'form-group' },
            el('label', { for: editUrlId }, '編集用URL'),
            el('div', { class: 'url-row' }, urlInput, copyBtn)
          ),
          el(
            'div',
            { class: 'muted' },
            '※ この URL をブックマークまたは保存してください'
          ),
          el(
            'div',
            { class: 'muted' },
            '※ この最小版は“メッセージ編集”を省略しています。必要なら後で追加可能。'
          )
        )
      )
    );
    return app;
  }

  function Vote(q) {
    const app = el('div');
    const { formId } = q;
    if (!formId) {
      return (set(app, el('div', {}, 'formIdがありません')), app);
    }
    const head = el('div', { class: 'card' }, el('h2', {}, '投票'));
    const dayNames = ['日', '月', '火', '水', '木', '金', '土'];
    const headerRow = el('div', { class: 'calendar-grid calendar-header' });
    dayNames.forEach((name, idx) =>
      headerRow.append(
        el(
          'div',
          {
            class:
              'day-label' +
              (idx === 0 ? ' sunday' : '') +
              (idx === 6 ? ' saturday' : ''),
          },
          name
        )
      )
    );
    const grid = el('div', { class: 'calendar-grid' });
    const calendar = el('div', { class: 'calendar' }, headerRow, grid);
    const normalMessage = '日付を選択して下さい。';
    const warningMessage = 'これ以上、選択できません。';
    const voteStatus = el('div', { class: 'vote-status' }, normalMessage);
    const voteCounter = el('div', { class: 'vote-counter' });
    const statusRow = el(
      'div',
      { class: 'status-row' },
      voteStatus,
      voteCounter
    );
    let warningTimer = null;
    const setNormalStatus = () => {
      voteStatus.textContent = normalMessage;
    };
    const showWarning = () => {
      voteStatus.textContent = warningMessage;
      clearTimeout(warningTimer);
      warningTimer = setTimeout(setNormalStatus, 3000);
    };
    const updateCounter = (remaining, maxVotes) => {
      if (maxVotes === null) {
        voteCounter.style.display = 'none';
        voteCounter.textContent = '';
        return;
      }
      voteCounter.style.display = '';
      voteCounter.textContent = `残り ${remaining}/${maxVotes}`;
    };
    set(
      app,
      el('div', {}, head, el('div', { class: 'card' }, statusRow, calendar))
    );
    fetch(API + '/forms/' + formId)
      .then(r => r.json())
      .then(j => {
        head.append(el('div', { class: 'muted' }, j.message || ''));
        render(j);
      })
      .catch(() => {
        grid.innerHTML = '<p>読み込み失敗</p>';
      });

    function render(j) {
      grid.innerHTML = '';
      clearTimeout(warningTimer);
      setNormalStatus();
      const voted = store.get(j.formId);
      const voteCount = voted.length;
      const maxVotes =
        j.maxVotes === undefined || j.maxVotes === null ? null : j.maxVotes;
      const remainingVotes =
        maxVotes === null ? null : Math.max(maxVotes - voteCount, 0);
      const limitReached = maxVotes !== null && voteCount >= maxVotes;
      updateCounter(remainingVotes, maxVotes);
      j.options.forEach(d => {
        const n = j.counts?.[d] || 0;
        const me = voted.includes(d);
        const [year, month, day] = d.split('-').map(Number);
        const dayOfWeek = new Date(year, month - 1, day).getDay();
        const isSunday = dayOfWeek === 0;
        const isSaturday = dayOfWeek === 6;
        const isDisabled = limitReached && !me;
        const handleVote = async () => {
          if (!me && limitReached) {
            showWarning();
            return;
          }
          if (me) {
            const r = await fetch(API + '/forms/' + j.formId + '/vote', {
              method: 'DELETE',
              headers: { 'content-type': 'application/json' },
              body: JSON.stringify({ date: d }),
            });
            if (!r.ok) {
              alert('取り消し失敗');
              return;
            }
            store.remove(j.formId, d);
            j.counts[d] = Math.max(0, (j.counts[d] || 0) - 1);
            render(j);
            return;
          }
          const r = await fetch(API + '/forms/' + j.formId + '/vote', {
            method: 'POST',
            headers: { 'content-type': 'application/json' },
            body: JSON.stringify({ date: d }),
          });
          if (!r.ok) {
            alert('投票失敗');
            return;
          }
          store.add(j.formId, d);
          j.counts[d] = (j.counts[d] || 0) + 1;
          render(j);
        };
        const b = el(
          'div',
          {
            class:
              'date-cell' +
              (me ? ' active' : '') +
              (isSunday ? ' sunday' : '') +
              (isSaturday ? ' saturday' : '') +
              (isDisabled ? ' disabled' : ''),
            style: `grid-column: ${dayOfWeek + 1}`,
            role: 'button',
            tabIndex: isDisabled ? -1 : 0,
            'aria-pressed': me,
            'aria-disabled': isDisabled,
            onclick: () => {
              if (isDisabled) {
                showWarning();
                return;
              }
              handleVote();
            },
            onkeydown: e => {
              if (isDisabled) return;
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                handleVote();
              }
            },
          },
          el('div', { class: 'date-label' }, fmtJP(d)),
          el('span', { class: 'pill-badge' }, String(n))
        );
        grid.append(b);
      });
    }
    return app;
  }

  function route() {
    const h = hash();
    const q = qs();
    if (h === '#/vote') return Vote(q);
    if (h === '#/edit') return Edit(q);
    return Create();
  }
  function render() {
    set(document.getElementById('app'), route());
  }
  window.addEventListener('hashchange', render);
  render();
</script>
